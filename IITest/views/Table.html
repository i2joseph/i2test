<!DOCTYPE html>
<html>
<head>
    <title>TableTest</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body ng-app="myApp" ng-controller="testController as tCtrl" ng-cloak>


    <div class="col-md-12">
        <div>
            <form style="margin-top:15px">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input-group-addon"><i class="fa fa-search"></i></div>
                        <input type="text" class="form-control" placeholder="Search Table" ng-model="tCtrl.searchTable">
                    </div>
                </div>
            </form>
        </div>
        <div>
            <table class="table table-striped table-hover table-bordered col-md-12">
                <thead>
                    <tr>
                        <th class="text-center">
                            <a href="#" ng-click="sortType = 'name'; sortReverse = !sortReverse">
                                Company Name
                                <span ng-show="sortType == 'name' && !sortReverse" class="fa fa-caret-down"></span>
                                <span ng-show="sortType == 'name' && sortReverse" class="fa fa-caret-up"></span>
                            </a>
                        </th>
                        <th class="text-center">Quarter Ending</th>
                        <th class="text-center">Sales</th>
                        <th class="text-center">Sales yoy pct</th>
                        <th class="text-center">Earnings</th>
                        <th class="text-center">Earnings_yoy_pct</th>
                        <th class="text-center">Ebitda</th>
                        <th class="text-center">Ebitda_margin</th>
                        <th class="text-center">Net_profit_margin</th>
                        <th class="text-center">
                            <a href="#" ng-click="sortType = 'country'; sortReverse = !sortReverse">
                                Country
                                <span ng-show="sortType == 'country' && !sortReverse" class="fa fa-caret-down"></span>
                                <span ng-show="sortType == 'country' && sortReverse" class="fa fa-caret-up"></span>
                            </a>
                        </th>
                        <th class="text-center">
                            <a href="#" ng-click="sortType = 'sector'; sortReverse = !sortReverse">
                                Sector
                                <span ng-show="sortType == 'sector' && !sortReverse" class="fa fa-caret-down"></span>
                                <span ng-show="sortType == 'sector' && sortReverse" class="fa fa-caret-up"></span>
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="item in tCtrl.items | orderBy:sortType:sortReverse | filter:tCtrl.searchTable">
                        <td>{{item.company_name}}</td>
                        <td>{{item.quarter_ending}}</td>
                        <td>{{item.sales}}</td>
                        <td>{{item.sales_yoy_pct}}</td>
                        <td>{{item.earnings_yoy_pct}}</td>
                        <td>{{item.ebitda}}</td>
                        <td>{{item.ebitda_margin}}</td>
                        <td>{{item.net_profit_margin}}</td>
                        <td>{{item.net_profit_margin}}</td>
                        <td>{{item.countryList}}</td>
                        <td>{{item.sector}}</td>
                    </tr>
                </tbody>
            </table>
            <!-- pager -->
            <div class="text-center">
                <ul ng-if="tCtrl.pager.pages.length" class="pagination">
                    <li ng-class="{disabled:tCtrl.pager.currentPage === 1}">
                        <a ng-click="tCtrl.setPage(1)">First</a>
                    </li>
                    <li ng-class="{disabled:tCtrl.pager.currentPage === 1}">
                        <a ng-click="tCtrl.setPage(tCtrl.pager.currentPage - 1)">Previous</a>
                    </li>
                    <li ng-repeat="page in tCtrl.pager.pages" ng-class="{active:tCtrl.pager.currentPage === page}">
                        <a ng-click="tCtrl.setPage(page)">{{page}}</a>
                    </li>
                    <li ng-class="{disabled:tCtrl.pager.currentPage === tCtrl.pager.totalPages}">
                        <a ng-click="tCtrl.setPage(tCtrl.pager.currentPage + 1)">Next</a>
                    </li>
                    <li ng-class="{disabled:tCtrl.pager.currentPage === tCtrl.pager.totalPages}">
                        <a ng-click="tCtrl.setPage(tCtrl.pager.totalPages)">Last</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script src="/scripts/table.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript">

        (function () {
            angular.module('myApp', []);
        })();

        (function () {
            angular.module("myApp")
            .factory('pagerService', PagerService)
            .controller('testController', TestController);
            TestController.$inject = ['$scope', '$http', '$timeout', 'pagerService'];

            function TestController($scope, $http, $timeout, PagerService) {
                vm = this;
                vm.$scope = $scope;
                vm.$http = $http;
                vm.table = null;
                vm.sortType = 'name'; // set the default sort type
                vm.sortReverse = false;  // set the default sort order
                vm.searchTable = '';     // set the default search/filter term
                vm.pager = {};
                vm.setPage = setPage;
                render();

                function render() {
                    $http.get('http://localhost:61928/scripts/table.json').success(function (data) {
                        vm.table = data;
                        vm.setPage(1);
                    });
                }
                function setPage(page) {
                    if (page < 1 || page > vm.pager.totalPages) {
                        return;
                    }

                    // get pager object from service
                    vm.pager = PagerService.GetPager(vm.table.length, page);

                    // get current page of items
                    vm.items = vm.table.slice(vm.pager.startIndex, vm.pager.endIndex + 1);
                }
            }

            function PagerService() {
                // service definition
                var service = {};

                service.GetPager = GetPager;

                return service;

                // service implementation
                function GetPager(totalItems, currentPage, pageSize) {
                    // default to first page
                    currentPage = currentPage || 1;

                    // default page size is 10
                    pageSize = pageSize || 10;

                    // calculate total pages
                    var totalPages = Math.ceil(totalItems / pageSize);

                    var startPage, endPage;
                    if (totalPages <= 10) {
                        // less than 10 total pages so show all
                        startPage = 1;
                        endPage = totalPages;
                    } else {
                        // more than 10 total pages so calculate start and end pages
                        if (currentPage <= 6) {
                            startPage = 1;
                            endPage = 10;
                        } else if (currentPage + 4 >= totalPages) {
                            startPage = totalPages - 9;
                            endPage = totalPages;
                        } else {
                            startPage = currentPage - 5;
                            endPage = currentPage + 4;
                        }
                    }

                    // calculate start and end item indexes
                    var startIndex = (currentPage - 1) * pageSize;
                    var endIndex = Math.min(startIndex + pageSize - 1, totalItems - 1);

                    // create an array of pages to ng-repeat in the pager control
                    var pages = _.range(startPage, endPage + 1);

                    // return object with all pager properties required by the view
                    return {
                        totalItems: totalItems,
                        currentPage: currentPage,
                        pageSize: pageSize,
                        totalPages: totalPages,
                        startPage: startPage,
                        endPage: endPage,
                        startIndex: startIndex,
                        endIndex: endIndex,
                        pages: pages
                    };
                }
            }
            })();
    </script>
</body>
</html>
